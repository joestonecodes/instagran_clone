{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h1>{{ user.username }}'s Profile</h1>
        <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" class="rounded-circle" alt="{{ user.username }}'s profile picture" width="150" height="150">
        <div class="mt-4">
            <h3>Stories</h3>
            <div class="row">
                {% for story in user.stories %}
                <div class="col-md-4 mb-3">
                    <a href="{{ url_for('main.view_story', story_id=story.id) }}">
                        <img src="{{ url_for('static', filename='story_pics/' + story.image_file) }}" alt="Story Image" class="img-fluid">
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        <h3>Posts</h3>
        {% if user != current_user %}
            {% if is_following %}
                <form action="{{ url_for('main.unfollow', username=user.username) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Unfollow</button>
                </form>
            {% else %}
                <form action="{{ url_for('main.follow', username=user.username) }}" method="POST">
                    <button type="submit" class="btn btn-primary">Follow</button>
                </form>
            {% endif %}
        {% endif %}
        {% for post in posts %}
        <div class="card mb-4">
            <img src="{{ url_for('main.uploaded_file', filename=post.image_file) }}" class="card-img-top" alt="Post image">
            <div class="card-body">
                <p class="card-text">
                    Posted by <strong>{{ post.author.username }}</strong>
                </p>
                <form method="POST" action="{{ url_for('main.like', post_id=post.id) }}">
                    <button type="submit" class="btn btn-link">
                        {% if current_user.is_authenticated and post.likes|selectattr('author_id', 'equalto', current_user.id)|list %}
                        <span>&#x2764;</span>
                        {% else %}
                        <span>&#x2661;</span>
                        {% endif %}
                        {{ post.likes|length }} Likes
                    </button>
                </form>
                <hr>
                <h5>Comments</h5>
                {% for comment in post.comments %}
                <div class="mb-2">
                    <strong>{{ comment.author.username }}:</strong> {{ comment.text }}
                </div>
                {% endfor %}
                {% if current_user.is_authenticated %}
                <form method="POST" action="{{ url_for('main.comment', post_id=post.id) }}">
                    {{ comment_form.hidden_tag() }}
                    <div class="form-group">
                        {{ comment_form.text(class="form-control", placeholder="Add a comment...") }}
                    </div>
                    <button type="submit" class="btn btn-primary">Comment</button>
                </form>
                {% endif %}
                <hr>
                <div>
                    <strong>Hashtags:</strong>
                    {% for hashtag in post.hashtags %}
                        <a href="{{ url_for('main.hashtag', hashtag=hashtag.name) }}">#{{ hashtag.name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
